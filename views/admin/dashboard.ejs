<%- include('../partials/head') %>

<body class="bg-[var(--white)] text-[var(--highlight)]">
<div class="min-h-screen flex">

  <%- include('../partials/sidebar-admin') %>

  <main class="flex-1 p-8 md:p-10 space-y-10 overflow-auto">
    <header>
      <h1 class="text-3xl font-semibold text-[var(--highlight-light)]">Admin Dashboard</h1>
      <p class="mt-1 text-sm text-gray-500">System-wide overview and control</p>
    </header>

    <%- include('../partials/flash') %>

    <!-- STATS -->
    <section class="grid grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="group bg-white p-6 rounded-xl border hover:bg-[var(--highlight-light)] hover:text-white transition">
        <p class="text-sm text-gray-500 group-hover:text-white">Total Complaints</p>
        <p class="mt-2 text-2xl font-semibold"><%= stats.total || 0 %></p>
      </div>
      <div class="group bg-white p-6 rounded-xl border hover:bg-[var(--highlight-light)] hover:text-white transition">
        <p class="text-sm text-gray-500 group-hover:text-white">Open</p>
        <p class="mt-2 text-2xl font-semibold"><%= stats.open || 0 %></p>
      </div>
      <div class="group bg-white p-6 rounded-xl border hover:bg-[var(--highlight-light)] hover:text-white transition">
        <p class="text-sm text-gray-500 group-hover:text-white">In Progress</p>
        <p class="mt-2 text-2xl font-semibold"><%= stats.in_progress || 0 %></p>
      </div>
      <div class="group bg-white p-6 rounded-xl border hover:bg-[var(--highlight-light)] hover:text-white transition">
        <p class="text-sm text-gray-500 group-hover:text-white">Resolved</p>
        <p class="mt-2 text-2xl font-semibold"><%= stats.resolved || 0 %></p>
      </div>
    </section>

    <!-- USER STATS -->
    <section class="grid grid-cols-3 gap-6 max-w-lg">
      <div class="bg-blue-50 border border-blue-100 p-5 rounded-xl">
        <p class="text-sm text-blue-600">Students</p>
        <p class="text-2xl font-semibold text-blue-700"><%= userStats?.students || 0 %></p>
      </div>
      <div class="bg-yellow-50 border border-yellow-100 p-5 rounded-xl">
        <p class="text-sm text-yellow-700">Staff</p>
        <p class="text-2xl font-semibold text-yellow-700"><%= userStats?.staff || 0 %></p>
      </div>
      <div class="bg-purple-50 border border-purple-100 p-5 rounded-xl">
        <p class="text-sm text-purple-600">Admins</p>
        <p class="text-2xl font-semibold text-purple-700"><%= userStats?.admins || 0 %></p>
      </div>
    </section>

    <!-- COMPLAINTS + CHART -->
    <section class="grid grid-cols-1 lg:grid-cols-12 gap-10 max-w-6xl">
      <div class="lg:col-span-7 bg-white rounded-2xl border p-6">
        <h3 class="text-lg font-semibold mb-6">Recent Complaints</h3>
        <div class="space-y-4">
          <% if (recent.length === 0) { %>
            <p class="text-center text-gray-400 py-8">No complaints yet.</p>
          <% } else { %>
            <% recent.forEach(c => { %>
            <div class="flex justify-between items-center border rounded-lg p-4">
              <div>
                <p class="font-medium"><%= c.title %></p>
                <p class="text-sm text-gray-500">
                  <%= c.student_name %> • <%= c.category %> •
                  <span class="<%= c.status === 'open' ? 'text-red-600' : c.status === 'in_progress' ? 'text-yellow-600' : 'text-green-600' %>">
                    <%= c.status === 'in_progress' ? 'In Progress' : c.status.charAt(0).toUpperCase() + c.status.slice(1) %>
                  </span>
                </p>
              </div>
              <a href="/admin/complaints/<%= c.id %>" class="btn-type-1 text-sm">Manage</a>
            </div>
            <% }) %>
          <% } %>
        </div>
        <div class="mt-4">
          <a href="/admin/complaints" class="text-sm text-[var(--highlight-light)] hover:underline">View all complaints →</a>
        </div>
      </div>

      <div class="lg:col-span-5 bg-white rounded-2xl border p-6 cursor-pointer hover:shadow-md transition" onclick="window.location.href='/admin/complaints'">
        <h3 class="text-lg font-semibold mb-2">Complaint Status</h3>
        <p class="text-sm text-gray-500 mb-6">Click to view and assign complaints</p>
        <div id="adminChart" class="w-full h-[260px]"></div>
      </div>
    </section>
  </main>
</div>

<script>
const chartData = <%- JSON.stringify(chartData) %>;
google.charts.load('current', { packages: ['corechart'] });
google.charts.setOnLoadCallback(() => {
  const data = new google.visualization.DataTable();
  data.addColumn('string', 'Status');
  data.addColumn('number', 'Count');
  if (chartData.length === 0) { data.addRows([['No Data', 1]]); }
  else { chartData.forEach(r => data.addRow([r.status === 'in_progress' ? 'In Progress' : r.status.charAt(0).toUpperCase() + r.status.slice(1), parseInt(r.count)])); }
  new google.visualization.PieChart(document.getElementById('adminChart')).draw(data, {
    colors: ['#BC6C25','#DDA15E','#606C38'], pieHole: 0.4,
    legend: { position: 'bottom' }, chartArea: { width: '90%', height: '85%' },
    backgroundColor: 'transparent'
  });
});
</script>
</body>
</html>
